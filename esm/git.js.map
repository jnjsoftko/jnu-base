{"version":3,"sources":["../src/git.ts"],"sourcesContent":["/** Github\n * References\n *   - [create repository](https://octokit.github.io/rest.js/v19#repos-create-for-authenticated-user)\n */\n\n// & Import AREA\n// &---------------------------------------------------------------------------\nimport Path from 'path';\n\n// ? External Modules\nimport { execSync } from 'child_process';\nimport { Octokit } from '@octokit/rest';\n\n// ? Internal Modules\nimport { loadJson } from './builtin.js';\nimport { sleep } from './basic.js';\nimport { PLATFORM } from './cli.js';\n\n// & Types AREA\n// &---------------------------------------------------------------------------\nimport type { GithubAccount, RepoOptions } from './types.js';\n\n// & Variables AREA\n// &---------------------------------------------------------------------------\nconst settingsPath = `${process.env.DEV_CONFIG_ROOT}/Environments` ?? 'C:/JnJ-soft/Developments/Environments';\n\n// & Functions AREA\n// &---------------------------------------------------------------------------\n/**\n * Github 계정 정보 조회\n * @param userName - Github 사용자명\n * @returns Github 계정 정보\n *\n * @example\n * ```ts\n * const account = findGithubAccount('username');\n * ```\n */\nconst findGithubAccount = (userName: string): GithubAccount => {\n  return loadJson(`${settingsPath}/Apis/github.json`)[userName];\n};\n\n/**\n * 모든 저장소 목록 조회\n */\nconst findAllRepos = (octokit: Octokit) => {\n  console.log(octokit.rest.repos);\n};\n\n/**\n * 새 저장소 생성\n */\nconst createRemoteRepo = (octokit: Octokit, options: RepoOptions) => {\n  console.log('#### createRemoteRepo options: ', options);\n  const defaults = {\n    auto_init: true,\n    private: false,\n    license_template: 'MIT',\n  };\n  return octokit.rest.repos.createForAuthenticatedUser({\n    ...defaults,\n    ...options,\n  });\n};\n\n/**\n * 빈 저장소 생성\n */\nconst createRemoteRepoEmpty = (octokit: Octokit, options: RepoOptions) => {\n  console.log('#### createRemoteRepoEmpty options: ', options);\n  return createRemoteRepo(octokit, {\n    ...options,\n    auto_init: false,\n    license_template: undefined,\n  });\n};\n\n/**\n * 저장소 삭제\n */\nconst deleteRemoteRepo = (octokit: Octokit, options: RepoOptions, account: GithubAccount) => {\n  const { name } = options;\n  console.log(`### deleteRemoteRepo: ${name}`);\n  return octokit.rest.repos.delete({\n    owner: account.userName,\n    repo: name,\n  });\n};\n\n/**\n * Git 설정 변경\n */\nconst setLocalConfig = (options: RepoOptions, account: GithubAccount, localPath: string) => {\n  let cmd = `cd ${localPath} && git config user.name \"${account.fullName}\"`;\n  cmd += ` && git config user.email \"${account.email}\"`;\n  cmd += ` && git remote set-url origin https://${account.token}@github.com/${account.userName}/${options.name}.git`;\n  console.log(cmd);\n  execSync(cmd);\n};\n\n/**\n * 로컬 저장소 초기화\n */\nconst initLocalRepo = (options: RepoOptions, account: GithubAccount, localPath: string) => {\n  const { name } = options;\n  const { fullName, email, token, userName } = account;\n\n  let cmd = `cd ${localPath} && git init`;\n  cmd += ` && git config user.name \"${fullName}\"`;\n  cmd += ` && git config user.email \"${email}\"`;\n  cmd += ` && git remote add origin https://${token}@github.com/${userName}/${name}.git`;\n  // cmd += ` && git remote set-url origin https://${account.token}@github.com/${account.userName}/${options.name}.git`;\n  cmd += ` && git add . && git commit -m \"Initial commit\"`;\n  console.log(cmd);\n  execSync(cmd);\n};\n\n/**\n * 저장소 복제\n */\nconst cloneRepo = (options: RepoOptions, account: GithubAccount, localPath: string) => {\n  const cmd = `cd ${Path.dirname(localPath)} && git clone https://${account.token}@github.com/${account.userName}/${\n    options.name\n  }.git`;\n  console.log(cmd);\n  execSync(cmd);\n};\n\n/**\n * 저장소 초기화 (생성, 복제, 설정)\n */\nconst initRepo = (octokit: Octokit, options: RepoOptions, account: GithubAccount, localPath: string) => {\n  createRemoteRepo(octokit, options); // !! 원격 저장소 생성 안됨\n  // let cmd = `xgit -e createRemoteRepo -u ${account.userName} -n ${options.name}`;\n  // console.log(`initRepo cmd: ${cmd}`);\n  // execSync(cmd);\n  sleep(5);\n  cloneRepo(options, account, localPath);\n  sleep(5);\n  setLocalConfig(options, account, localPath);\n};\n\n/**\n * 저장소 복제 및 설정\n */\nconst copyRepo = (options: RepoOptions, account: GithubAccount, localPath: string) => {\n  cloneRepo(options, account, localPath);\n  sleep(10);\n  setLocalConfig(options, account, localPath);\n};\n\n/**\n * 저장소에 변경사항 푸시\n */\nconst pushRepo = (options: RepoOptions, account: GithubAccount, localPath: string) => {\n  execSync(`cd ${localPath}`);\n\n  // 변경사항이 있는지 확인\n  const status = execSync('git status --porcelain', { encoding: 'utf8' });\n\n  // 변경사항이 있으면 커밋\n  if (status.length > 0) {\n    const cmd = `git add . && git commit -m \"Initial commit\"`;\n    console.log('#### ', cmd);\n    execSync(cmd);\n  }\n\n  const branches = execSync('git branch');\n  console.log(`#### pushRepo branches: ${branches}`);\n\n  if (branches.includes('main')) {\n    execSync('git push -u origin main --force');\n  } else if (branches.includes('master')) {\n    execSync('git push -u origin master --force');\n  } else {\n    console.log('main 또는 master 브랜치가 없습니다.');\n  }\n};\n\n/**\n * 새 저장소 생성 및 초기 커밋\n */\nconst makeRepo = (octokit: Octokit, options: RepoOptions, account: GithubAccount, localPath: string) => {\n  // // 빈 저장소 생성\n  // console.log(`=================== createRemoteRepoEmpty: ${localPath}`);\n  // createRemoteRepoEmpty(octokit, options);\n  // createRemoteRepo(octokit, options);\n  let cmd = `xgit -e createRemoteRepo -u ${account.userName} -n ${options.name}`;\n  console.log(`initRepo cmd: ${cmd}`);\n  execSync(cmd);\n  sleep(15);\n  // 로컬 저장소 초기화\n  console.log(`=================== initLocalRepo: ${localPath}`);\n  initLocalRepo(options, account, localPath);\n  sleep(5);\n  // 로컬 저장소 디렉토리로 이동\n  // execSync(`cd ${localPath}`);\n  // 초기 커밋 및 푸시\n  console.log(`=================== pushRepo: ${localPath}`);\n  pushRepo(options, account, localPath);\n};\n\n/**\n * 로컬 + 원격 저장소 삭제\n */\nconst removeRepo = (octokit: Octokit, options: RepoOptions, account: GithubAccount, localPath: string) => {\n  deleteRemoteRepo(octokit, options, account);\n  sleep(10);\n  const { name } = options;\n\n  if (PLATFORM === 'win') {\n    // Windows에서는 각 명령어를 개별적으로 실행\n    try {\n      const cdCmd = `cd ${Path.dirname(localPath)}`;\n      console.log(cdCmd);\n      execSync(cdCmd);\n\n      const rmCmd = `rmdir /s /q ${name}`;\n      console.log(rmCmd);\n      execSync(rmCmd);\n    } catch (error) {\n      console.error('Failed to remove directory:', error);\n      // 실패 시 대체 방법 시도\n      try {\n        const altCmd = `rd /s /q \"${localPath}\"`;\n        console.log('Trying alternative command:', altCmd);\n        execSync(altCmd);\n      } catch (err) {\n        console.error('Alternative removal also failed:', err);\n      }\n    }\n  } else {\n    // Unix 계열은 한 번에 실행\n    const cmd = `cd ${Path.dirname(localPath)} && rm -rf ${name}`;\n    console.log(cmd);\n    execSync(cmd);\n  }\n};\n\n// & Export AREA\n// &---------------------------------------------------------------------------\nexport {\n  findGithubAccount,\n  findAllRepos,\n  createRemoteRepo,\n  createRemoteRepoEmpty,\n  deleteRemoteRepo,\n  cloneRepo,\n  setLocalConfig,\n  initLocalRepo,\n  initRepo,\n  copyRepo,\n  pushRepo,\n  makeRepo,\n  removeRepo,\n};\n"],"names":["Path","execSync","loadJson","sleep","PLATFORM","settingsPath","process","env","DEV_CONFIG_ROOT","findGithubAccount","userName","findAllRepos","octokit","console","log","rest","repos","createRemoteRepo","options","defaults","auto_init","private","license_template","createForAuthenticatedUser","createRemoteRepoEmpty","undefined","deleteRemoteRepo","account","name","delete","owner","repo","setLocalConfig","localPath","cmd","fullName","email","token","initLocalRepo","cloneRepo","dirname","initRepo","copyRepo","pushRepo","status","encoding","length","branches","includes","makeRepo","removeRepo","cdCmd","rmCmd","error","altCmd","err"],"mappings":"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"}